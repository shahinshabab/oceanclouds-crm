{% extends "ui/base.html" %}
{% load roles_tags %}

{% block title %}Client – {{ client }}{% endblock %}

{% block content %}
{% is_admin request.user as is_admin %}
{% is_manager request.user as is_manager %}
{% is_employee request.user as is_employee %}

<div class="container py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-semibold mb-1">{{ client }}</h2>
      {% if not client.is_active %}
        <span class="badge bg-secondary">Inactive</span>
      {% endif %}
    </div>
    <div class="text-end">

      {% if is_admin or is_manager %}
        <a href="{% url 'crm:client_update' client.pk %}" class="btn btn-primary btn-sm">
          Edit Client
        </a>
      {% endif %}
      <a href="{% url 'crm:client_list' %}" class="btn btn-secondary btn-sm">
        Back to Clients
      </a>
    </div>
  </div>

  <!-- Client Information -->
  <div class="card mb-4 shadow-sm">
    <div class="card-body">

      <!-- Row 1 -->
      <div class="row mb-3">
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Name</div>
          <div class="fw-semibold mt-1">{{ client.name }}</div>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Display Name</div>
          <div class="fw-semibold mt-1">{{ client.display_name|default:"—" }}</div>
        </div>
        <div class="col-md-4">
          <div class="text-muted small text-uppercase">Primary Contact</div>
          <div class="fw-semibold mt-1">
            {% if client.primary_contact %}
              {{ client.primary_contact.first_name }} {{ client.primary_contact.last_name }}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Row 2 -->
      <div class="row mb-3">
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Email</div>
          <div class="fw-semibold mt-1">
            {% if client.email %}
              <a href="mailto:{{ client.email }}">{{ client.email }}</a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Phone</div>
          <div class="fw-semibold mt-1">
            {{ client.phone|default:"—" }}
          </div>
        </div>
        <div class="col-md-4">
          <div class="text-muted small text-uppercase">District</div>
          <div class="fw-semibold mt-1">
            {{ client.district|default:"—" }}
          </div>
        </div>
      </div>

      <!-- Row 3 -->
      <div class="row mb-3">
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">City</div>
          <div class="fw-semibold mt-1">
            {{ client.city|default:"—" }}
          </div>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">State</div>
          <div class="fw-semibold mt-1">
            {{ client.state|default:"—" }}
          </div>
        </div>
        <div class="col-md-4">
          <div class="text-muted small text-uppercase">Country</div>
          <div class="fw-semibold mt-1">
            {{ client.country|default:"—" }}
          </div>
        </div>
      </div>

      <!-- Row 4 -->
      <div class="row mb-3">
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Instagram</div>
          <div class="fw-semibold mt-1">
            {% if client.instagram_handle %}
              <a href="https://instagram.com/{{ client.instagram_handle|cut:'@' }}"
                 target="_blank">
                @{{ client.instagram_handle|cut:'@' }}
              </a>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Status</div>
          <div class="fw-semibold mt-1">
            {% if client.is_active %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </div>
        </div>
        <div class="col-md-4">
          <!-- Reserved for future info (e.g., total events) -->
        </div>
      </div>

      <!-- Row 5: Billing address -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="text-muted small text-uppercase">Billing Address</div>
          <div class="mt-1">
            {{ client.billing_address|linebreaks|default:"<span class='text-muted'>—</span>"|safe }}
          </div>
        </div>
      </div>

      <!-- Row 6: Notes -->
      <div class="row mb-3">
        <div class="col-12">
          <div class="text-muted small text-uppercase">Notes</div>
          <div class="mt-1">
            {{ client.notes|linebreaks|default:"<span class='text-muted'>—</span>"|safe }}
          </div>
        </div>
      </div>

      <!-- Actions row (duplicate of header buttons, but centered) -->
      <div class="row">
        <div class="col-12 d-flex justify-content-center gap-2 mt-2">
          {% if is_admin or is_manager %}
            <a href="{% url 'crm:client_update' client.pk %}"
               class="btn btn-primary px-4">
              Edit Client
            </a>
          {% endif %}
          <a href="{% url 'crm:client_list' %}"
             class="btn btn-outline-secondary">
            Back to Clients
          </a>
        </div>
      </div>

    </div>
  </div>

  <!-- Contacts Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <span>Contacts</span>

      {% if is_admin or is_manager %}
        <a href="{% url 'crm:contact_create' %}?client={{ client.pk }}" class="btn btn-light btn-sm">
          + Add Contact
        </a>
      {% endif %}
    </div>
    <div class="card-body">
      {% if client.contacts.all %}
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr>
            <th>Name</th>
            <th>Role</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Primary</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for contact in client.contacts.all %}
          <tr>
            <td>{{ contact.first_name }} {{ contact.last_name }}</td>
            <td>{{ contact.get_role_display|default:"—" }}</td>
            <td>
              {% if contact.email %}
                <a href="mailto:{{ contact.email }}">{{ contact.email }}</a>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td>{{ contact.phone|default:"—" }}</td>
            <td>
              {% if contact.is_primary %}
                <span class="badge bg-success">Yes</span>
              {% else %}
                <span class="text-muted">No</span>
              {% endif %}
            </td>
            <td class="text-end">
              {% if is_admin or is_manager %}
                <a href="{% url 'crm:contact_update' contact.pk %}"
                   class="btn btn-outline-secondary btn-sm">
                  Edit
                </a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
        <p class="text-muted mb-0">No contacts added yet.</p>
      {% endif %}
    </div>
  </div>

  <!-- Leads Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-info text-white">
      Leads Linked to This Client
    </div>
    <div class="card-body">
      {% if client.leads.all %}
        <ul class="list-group">
          {% for lead in client.leads.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              <strong>{{ lead.name }}</strong>
              — {{ lead.get_status_display }}
            </span>
            <a href="{% url 'crm:lead_detail' lead.pk %}" class="btn btn-sm btn-outline-primary">
              View
            </a>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No leads linked.</p>
      {% endif %}
    </div>
  </div>

  <!-- Inquiries Section -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header bg-secondary text-white">
      Inquiries Related to This Client
    </div>
    <div class="card-body">
      {% if client.inquiries.all %}
        <ul class="list-group">
          {% for inquiry in client.inquiries.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span>
              {{ inquiry.get_channel_display }} — {{ inquiry.name|default:"(No name)" }}
            </span>
            <a href="{% url 'crm:inquiry_detail' inquiry.pk %}"
               class="btn btn-sm btn-outline-secondary">
              View
            </a>
          </li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mb-0">No inquiries found.</p>
      {% endif %}
    </div>
  </div>

</div>
{% endblock %}
