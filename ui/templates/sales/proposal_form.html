{% extends "ui/base.html" %}
{% load static %}
{% load roles_tags %}

{% block title %}
  {% if form.instance.pk %}Edit Proposal{% else %}New Proposal{% endif %}
{% endblock %}

{% block content %}
{% is_admin as is_admin %}
{% is_manager as is_manager %}
{% is_employee as is_employee %}

<div class="container py-3 max-w-2xl">

  <h2 class="fw-semibold mb-4">
    {% if form.instance.pk %}Edit Proposal{% else %}New Proposal{% endif %}
  </h2>

  <form method="post" novalidate>
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="alert alert-danger">
        {{ form.non_field_errors }}
      </div>
    {% endif %}

    <!-- ================= HEADER CARD ================= -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">

        <!-- Row 1: Deal / Title / Status -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.deal.label }}{% if form.deal.field.required %} *{% endif %}
            </label>
            {{ form.deal }}
            {% for error in form.deal.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.title.label }}{% if form.title.field.required %} *{% endif %}
            </label>
            {{ form.title }}
            {% for error in form.title.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.status.label }}{% if form.status.field.required %} *{% endif %}
            </label>
            {{ form.status }}
            {% for error in form.status.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <!-- Row 2: Version / Valid Until / Subtotal -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.version.label }}
            </label>
            {{ form.version }}
            {% for error in form.version.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.valid_until.label }}
            </label>
            {{ form.valid_until }}
            {% for error in form.valid_until.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.subtotal.label }}
            </label>
            {{ form.subtotal }}
            {% for error in form.subtotal.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <!-- Row 3: Discount / Tax / Total -->
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.discount.label }}
            </label>
            {{ form.discount }}
            {% for error in form.discount.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.tax.label }}
            </label>
            {{ form.tax }}
            {% if form.tax.help_text %}
              <small class="form-text text-muted">{{ form.tax.help_text }}</small>
            {% endif %}
            {% for error in form.tax.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>

          <div class="col-md-4 mb-3">
            <label class="form-label">
              {{ form.total.label }}
            </label>
            {{ form.total }}
            {% for error in form.total.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

        <!-- Row 4: Notes (full width) -->
        <div class="row">
          <div class="col-12 mb-3">
            <label class="form-label">
              {{ form.notes.label }}
            </label>
            {{ form.notes }}
            {% for error in form.notes.errors %}
              <div class="text-danger small">{{ error }}</div>
            {% endfor %}
          </div>
        </div>

      </div>
    </div>

    <!-- ================= ITEMS CARD ================= -->
    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span class="fw-semibold small text-uppercase text-muted">Items</span>
        <button type="button"
                class="btn btn-sm btn-outline-success"
                id="add-item-row">
          + Add Item
        </button>
      </div>

      <div class="card-body p-0">

        {{ item_formset.management_form }}

        <table class="table table-sm mb-0 align-middle" id="items-table">
          <thead class="table-light">
            <tr>
              <th style="width: 18%;">Service</th>
              <th style="width: 18%;">Package</th>
              <th style="width: 34%;">Description</th>
              <th class="text-end" style="width: 10%;">Qty</th>
              <th class="text-end" style="width: 15%;">Unit Price</th>
              <th class="text-end" style="width: 5%;">Delete</th>
            </tr>
          </thead>
          <tbody>
          {% for form_item in item_formset %}
            <tr class="item-row">
              {# Hidden id field so edits work correctly #}
              {{ form_item.id }}

              <td>
                {{ form_item.service }}
                {% for error in form_item.service.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>

              <td>
                {{ form_item.package }}
                {% for error in form_item.package.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>

              <td>
                {{ form_item.description }}
                {% for error in form_item.description.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>

              <td class="text-end">
                {{ form_item.quantity }}
                {% for error in form_item.quantity.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>

              <td class="text-end">
                {{ form_item.unit_price }}
                {% for error in form_item.unit_price.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </td>

              <td class="text-end">
                {% if form_item.DELETE %}
                  <div class="form-check d-flex justify-content-end">
                    {{ form_item.DELETE }}
                  </div>
                {% endif %}
              </td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

      </div>
    </div>

    <!-- Buttons -->
    <div class="row mt-3">
      <div class="col-12 d-flex justify-content-center gap-2">
        {% if is_admin or is_manager %}
          <button type="submit" class="btn btn-primary px-4">
            Save
          </button>
        {% endif %}  
        <a href="{% url 'sales:proposal_list' %}" class="btn btn-secondary">
          Cancel
        </a>
      </div>
    </div>

  </form>

</div>

<script>
  (function () {
    const addBtn = document.getElementById("add-item-row");
    const tableBody = document.querySelector("#items-table tbody");
    if (!addBtn || !tableBody) return;

    addBtn.addEventListener("click", function () {
      const totalFormsInput = document.querySelector(
        'input[name="{{ item_formset.prefix }}-TOTAL_FORMS"]'
      );
      let totalForms = parseInt(totalFormsInput.value, 10);

      // clone last row
      const lastRow = tableBody.querySelector("tr.item-row:last-child");
      if (!lastRow) return;

      const newRow = lastRow.cloneNode(true);

      // clear all validation messages
      newRow.querySelectorAll(".text-danger").forEach(el => el.remove());

      newRow.querySelectorAll("input, select, textarea").forEach(function (el) {
        if (el.name) {
          el.name = el.name.replace(/-\d+-/, "-" + totalForms + "-");
        }
        if (el.id) {
          el.id = el.id.replace(/-\d+-/, "-" + totalForms + "-");
        }

        // For DELETE checkbox: always unchecked
        if (el.type === "checkbox") {
          el.checked = false;
        } else {
          // clear value
          el.value = "";
        }
      });

      tableBody.appendChild(newRow);
      totalFormsInput.value = totalForms + 1;
    });
  })();
</script>

{% endblock %}
