{# events/event_calendar.html #}
{% extends "ui/base.html" %}
{% block title %}Event Calendar{% endblock %}

{% block content %}
<div class="container-fluid px-3 pt-0 pb-3">

  <!-- Calendar styles -->
  <style>
    .calendar-scroll {
      max-height: 600px;
      overflow-x: auto;   /* horizontal scroll */
      overflow-y: auto;   /* vertical scroll */
      position: relative;
    }

    .calendar-table {
      border-collapse: separate;
      border-spacing: 0;
      width: max-content; /* let table expand so X can scroll */
    }

    .calendar-table thead th {
      position: static !important;
    }

    /* Fixed width for time column (Y axis) */
    .calendar-table .time-col,
    .calendar-table .time-cell {
      width: 80px;
      min-width: 80px;
      max-width: 80px;
      text-align: left;
      background-color: #ffffff;
      white-space: nowrap;
    }

    /* Y axis: Time column sticky on the LEFT */
    .calendar-table th.time-col,
    .calendar-table td.time-cell {
      position: sticky !important;
      left: 0;
      z-index: 5;
      background-color: #ffffff;
    }

    /* Corner cell at top-left */
    .calendar-table .corner-cell {
      z-index: 6;
      background-color: #ffffff;
    }

    /* X axis: Date columns – fixed width */
    .calendar-table th.date-col,
    .calendar-table td.date-cell {
      min-width: 140px;
      max-width: 140px;
    }

    .calendar-table th.date-col {
      white-space: nowrap;  /* keep "Dec 8 - Mon" on one line */
      font-size: 0.85rem;
      text-align: center;
    }

    /* Fixed height for each time row – ORIGINAL GAP RESTORED */
    .calendar-table .slot-row td {
      height: 60px;
      vertical-align: top;
    }

    /* Event pill */
    .calendar-event-pill {
      min-height: 40px;
      border-radius: 0.4rem;
      font-size: 0.8rem;
    }
  </style>

  <!-- Filters Row -->
  <form method="get" class="row g-2 mb-2">

    <div class="col-md-4">
      <label class="form-label small text-muted mb-1">View Range</label>
      <select name="range" class="form-select">
        <option value="1m" {% if range_param == "1m" %}selected{% endif %}>1 month</option>
        <option value="2m" {% if range_param == "2m" %}selected{% endif %}>2 months</option>
        <option value="3m" {% if range_param == "3m" %}selected{% endif %}>3 months</option>
      </select>
    </div>

    <div class="col-md-4">
      <label class="form-label small text-muted mb-1">Event Type</label>
      <select name="event_type" class="form-select">
        <option value="">All types</option>
        {% for value, label in event_type_choices %}
          <option value="{{ value }}" {% if event_type == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label small text-muted mb-1">Status</label>
      <select name="status" class="form-select">
        <option value="">All statuses</option>
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if status == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-1 d-flex align-items-end">
      <div class="d-grid w-100">
        <button type="submit" class="btn btn-outline-secondary">
          Apply
        </button>
      </div>
    </div>
  </form>

  <!-- Calendar Grid -->
  <div class="card">
    <div class="card-body p-0">

      <div class="calendar-scroll">
        <table class="table table-sm mb-0 align-middle calendar-table">

          <!-- Header: Dates (X-axis) -->
          <thead class="table-light">
            <tr>
              <th scope="col" class="time-col corner-cell">
                Time
              </th>
              {% for d in dates %}
                <th scope="col" class="date-col">
                  {{ d|date:"M d" }} - <span class="text-muted small">{{ d|date:"D" }}</span>
                </th>
              {% endfor %}
            </tr>
          </thead>

          <tbody>
            {% if dates %}
              {% for row in time_rows %}
                {# Show only 10:00–19:00 (10 AM–7 PM) #}
                {% if row.hour >= 10 and row.hour <= 19 %}
                  <tr class="slot-row">
                    <!-- Y axis: Time label (fixed left) -->
                    <td class="fw-semibold text-nowrap time-cell">
                      {{ row.hour|stringformat:"02d" }}:00
                    </td>

                    <!-- X axis: Dates (scroll horizontally) -->
                    {% for cell in row.cells %}
                      <td class="date-cell">
                        {% if cell.events %}
                          {% for ev in cell.events %}
                            <a href="{% url 'events:event_detail' ev.pk %}"
                               class="text-decoration-none d-block mb-1">
                              {% with ev.status as st %}
                                <div class="calendar-event-pill text-white px-2 py-1
                                  {% if st == 'completed' %} bg-success
                                  {% elif st == 'confirmed' %} bg-primary
                                  {% elif st == 'tentative' %} bg-warning text-dark
                                  {% elif st == 'cancelled' %} bg-danger
                                  {% else %} bg-secondary
                                  {% endif %}
                                ">
                                  <div class="fw-semibold small">
                                    {{ ev.name|truncatechars:28 }}
                                  </div>
                                  <div class="small">
                                    {% if ev.start_time %}
                                      {{ ev.start_time|time:"H:i" }}
                                    {% endif %}
                                    {% if ev.client %}
                                      • {{ ev.client }}
                                    {% endif %}
                                  </div>
                                </div>
                              {% endwith %}
                            </a>
                          {% endfor %}
                        {% endif %}
                      </td>
                    {% endfor %}
                  </tr>
                {% endif %}
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="999" class="text-center text-muted py-4">
                  No upcoming events in this range.
                </td>
              </tr>
            {% endif %}
          </tbody>

        </table>
      </div>

    </div>
  </div>

</div>
{% endblock %}
