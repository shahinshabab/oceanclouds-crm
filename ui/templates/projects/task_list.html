{% extends "ui/base.html" %}
{% load roles_tags %}

{% block content %}
<div class="container py-4">

  {# Role flags – keep consistent with other templates #}
  {% is_admin request.user as is_admin %}
  {% is_manager request.user as is_manager %}
  {% is_employee request.user as is_employee %}

  <!-- Header Row -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h1 class="h3 mb-0">Tasks</h1>
      <small class="text-muted">
        {% if is_admin %}
          Viewing all tasks (admin).
        {% elif is_manager %}
          Tasks for projects you manage (excluding completed projects).
        {% else %}
          Tasks assigned to you (excluding completed projects).
        {% endif %}
      </small>
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'projects:task_kanban' %}" class="btn btn-outline-secondary btn-sm">
        Kanban View
      </a>

      {% if is_admin or is_manager %}
        <a href="{% url 'projects:task_create' %}" class="btn btn-success btn-sm">
          + New Task
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Search + Filters Row -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <!-- Search -->
    <div class="col-md-5">
      <label class="form-label small text-muted text-uppercase mb-1">Search</label>
      <input type="text"
             name="q"
             value="{{ q }}"
             class="form-control"
             placeholder="Search by task or project name">
    </div>

    <!-- Status filter -->
    <div class="col-md-3">
      <label class="form-label small text-muted text-uppercase mb-1">Status</label>
      <select name="status" class="form-select">
        <option value="">All statuses</option>
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Due filter (e.g. Overdue / All) -->
    <div class="col-md-3">
      <label class="form-label small text-muted text-uppercase mb-1">Due</label>
      <select name="due" class="form-select">
        <option value="">All</option>
        <option value="overdue" {% if due_filter == "overdue" %}selected{% endif %}>
          Overdue only
        </option>
      </select>
    </div>

    <div class="col-md-1 d-grid">
      <button class="btn btn-outline-secondary" type="submit">
        Apply
      </button>
    </div>
  </form>

  <!-- Data Table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive mb-0">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Task</th>
              <th>Project</th>
              <th>Assigned To</th>
              <th>Status</th>
              <th>Priority</th>
              <th>Due</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for task in tasks %}
              <tr>
                <!-- Task -->
                <td>
                  <a href="{% url 'projects:task_detail' task.pk %}"
                     class="fw-semibold text-decoration-none">
                    {{ task.name }}
                  </a>
                </td>

                <!-- Project (hide link for employees) -->
                <td>
                  {% if is_admin or is_manager %}
                    <a href="{% url 'projects:project_detail' task.project.pk %}"
                       class="text-decoration-none">
                      {{ task.project.name }}
                    </a>
                  {% else %}
                    {{ task.project.name }}
                  {% endif %}
                  <br>
                  <small class="text-muted">
                    Client: {{ task.project.client }}
                  </small>
                </td>

                <!-- Assigned To -->
                <td>
                  {% if task.assigned_to %}
                    {{ task.assigned_to.get_full_name|default:task.assigned_to.username }}
                  {% else %}
                    <span class="text-muted">Unassigned</span>
                  {% endif %}
                </td>

                <!-- Status -->
                <td>
                  {% if task.status == "completed" %}
                    <span class="badge bg-success">{{ task.get_status_display }}</span>
                  {% elif task.status == "in_progress" %}
                    <span class="badge bg-primary">{{ task.get_status_display }}</span>
                  {% elif task.status == "blocked" %}
                    <span class="badge bg-danger">{{ task.get_status_display }}</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ task.get_status_display }}</span>
                  {% endif %}
                </td>

                <!-- Priority -->
                <td>
                  {% if task.priority == "critical" %}
                    <span class="badge bg-danger">Critical</span>
                  {% elif task.priority == "high" %}
                    <span class="badge bg-warning text-dark">High</span>
                  {% elif task.priority == "medium" %}
                    <span class="badge bg-primary">Medium</span>
                  {% else %}
                    <span class="badge bg-light text-dark">Low</span>
                  {% endif %}
                </td>

                <!-- Due -->
                <td>
                  {% if task.due_date %}
                    {{ task.due_date }}
                    {% if task.is_overdue %}
                      <span class="badge bg-danger ms-1">Overdue</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <!-- Actions -->
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <a href="{% url 'projects:task_detail' task.pk %}"
                       class="btn btn-outline-secondary">
                      View
                    </a>
                    {% if is_admin or is_manager %}
                      <a href="{% url 'projects:task_update' task.pk %}"
                         class="btn btn-outline-secondary">
                        Edit
                      </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No tasks found.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
    <nav aria-label="Task pagination" class="mt-3">
      <ul class="pagination mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status_filter }}&due={{ due_filter }}">
              Previous
            </a>
          </li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status_filter }}&due={{ due_filter }}">
              Next
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>
{% endblock %}
