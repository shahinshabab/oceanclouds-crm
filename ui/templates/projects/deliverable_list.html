{% extends "ui/base.html" %}
{% load roles_tags %}

{% block content %}
<div class="container py-4">

  {# Role flags #}
  {% is_admin request.user as is_admin %}
  {% is_manager request.user as is_manager %}
  {% is_employee request.user as is_employee %}

  <!-- Header Row -->
  <div class="d-flex justify-content-between align-items-center mb-2">
    <div>
      <h1 class="h3 mb-0">Deliverables</h1>
      <small class="text-muted">
        Only deliverables from non-completed projects are listed.
      </small>
    </div>

    <div class="d-flex gap-2">
      <a href="{% url 'projects:deliverable_kanban' %}"
         class="btn btn-outline-secondary btn-sm">
        Kanban View
      </a>

      {% if is_admin or is_manager %}
        <a href="{% url 'projects:deliverable_create' %}"
           class="btn btn-success btn-sm">
          + New Deliverable
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Search + Filters -->
  <form method="get" class="row g-2 align-items-end mb-3">
    <!-- Search -->
    <div class="col-md-6">
      <label class="form-label small text-muted text-uppercase mb-1">Search</label>
      <input type="text"
             name="q"
             value="{{ q }}"
             class="form-control"
             placeholder="Search by deliverable or project name">
    </div>

    <!-- Status -->
    <div class="col-md-3">
      <label class="form-label small text-muted text-uppercase mb-1">Status</label>
      <select name="status" class="form-select">
        <option value="">All statuses</option>
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Type -->
    <div class="col-md-3">
      <label class="form-label small text-muted text-uppercase mb-1">Type</label>
      <select name="type" class="form-select">
        <option value="">All types</option>
        {% for value, label in type_choices %}
          <option value="{{ value }}" {% if type_filter == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

  </form>

  <!-- Table -->
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Project</th>
              <th>Assigned To</th>
              <th>Type</th>
              <th>Status</th>
              <th>Due</th>
              <th class="text-end">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for d in deliverables %}
              <tr>
                <!-- Name -->
                <td>
                  <a href="{% url 'projects:deliverable_detail' d.pk %}"
                     class="fw-semibold text-decoration-none">
                    {{ d.name }}
                  </a>
                </td>

                <!-- Project -->
                <td>
                  {% if is_admin or is_manager %}
                    <a href="{% url 'projects:project_detail' d.project.pk %}"
                       class="text-decoration-none">
                      {{ d.project.name }}
                    </a>
                  {% else %}
                    {{ d.project.name }}
                  {% endif %}
                  <br>
                  <small class="text-muted">
                    Client: {{ d.project.client }}
                  </small>
                </td>

                <!-- Assigned To -->
                <td>
                  {% if d.assigned_to %}
                    {{ d.assigned_to.get_full_name|default:d.assigned_to.username }}
                  {% else %}
                    <span class="text-muted">Unassigned</span>
                  {% endif %}
                </td>

                <!-- Type -->
                <td>{{ d.get_type_display }}</td>

                <!-- Status -->
                <td>
                  {% if d.status == "delivered" %}
                    <span class="badge bg-success">{{ d.get_status_display }}</span>
                  {% elif d.status == "in_progress" %}
                    <span class="badge bg-primary">{{ d.get_status_display }}</span>
                  {% elif d.status == "pending" %}
                    <span class="badge bg-secondary">{{ d.get_status_display }}</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ d.get_status_display }}</span>
                  {% endif %}
                </td>

                <!-- Due -->
                <td>
                  {% if d.due_date %}
                    {{ d.due_date }}
                    {% if d.is_overdue %}
                      <span class="badge bg-danger ms-1">Overdue</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>

                <!-- Actions -->
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    <a href="{% url 'projects:deliverable_detail' d.pk %}"
                       class="btn btn-outline-secondary">
                      View
                    </a>
                    {% if is_admin or is_manager %}
                      <a href="{% url 'projects:deliverable_update' d.pk %}"
                         class="btn btn-outline-secondary">
                        Edit
                      </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No deliverables found.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  {% if is_paginated %}
    <nav aria-label="Deliverable pagination" class="mt-3">
      <ul class="pagination mb-0">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.previous_page_number }}&q={{ q }}&status={{ status_filter }}&type={{ type_filter }}">
              Previous
            </a>
          </li>
        {% endif %}

        <li class="page-item disabled">
          <span class="page-link">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
          </span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link"
               href="?page={{ page_obj.next_page_number }}&q={{ q }}&status={{ status_filter }}&type={{ type_filter }}">
              Next
            </a>
          </li>
        {% endif %}
      </ul>
    </nav>
  {% endif %}

</div>
{% endblock %}
