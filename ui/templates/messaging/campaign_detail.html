{% extends "ui/base.html" %}
{% load roles_tags %}

{% block title %}Campaign – {{ campaign.name }}{% endblock %}

{% block content %}
{% is_admin request.user as is_admin %}
{% is_manager request.user as is_manager %}
{% is_employee request.user as is_employee %}

<div class="container py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-semibold mb-1">{{ campaign.name }}</h2>
      <small class="text-muted">
        Status: {{ campaign.get_status_display }} ·
        Template: {{ campaign.template.name }} ·
        Created: {{ campaign.created_at|date:"Y-m-d H:i" }}
      </small>
    </div>
    <div class="text-end">
      {% if is_admin or is_manager %}
        <a href="{% url 'messaging:campaign_update' campaign.pk %}"
           class="btn btn-primary btn-sm">
          Edit Campaign
        </a>
        <form action="{% url 'messaging:campaign_send_now' campaign.pk %}"
              method="post" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-success btn-sm">
            Send Now
          </button>
        </form>
      {% endif %}
      <a href="{% url 'messaging:campaign_list' %}" class="btn btn-secondary btn-sm">
        Back to Campaigns
      </a>
    </div>
  </div>

  <div class="card mb-4 shadow-sm">
    <div class="card-body">

      <div class="row mb-3">
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Template</div>
          <div class="fw-semibold mt-1">{{ campaign.template.name }}</div>
        </div>
        <div class="col-md-4 mb-3 mb-md-0">
          <div class="text-muted small text-uppercase">Integration</div>
          <div class="fw-semibold mt-1">
            {{ campaign.integration|default:"Default" }}
          </div>
        </div>
        <div class="col-md-4">
          <div class="text-muted small text-uppercase">Scheduled For</div>
          <div class="fw-semibold mt-1">
            {{ campaign.scheduled_for|date:"Y-m-d H:i"|default:"—" }}
          </div>
        </div>
      </div>

      <div class="mb-3">
        <div class="text-muted small text-uppercase">Subject</div>
        <div class="fw-semibold mt-1">
          {{ campaign.subject }}
        </div>
      </div>

      <div class="mb-3">
        <div class="text-muted small text-uppercase">Segment Description</div>
        <div class="mt-1">
          {{ campaign.segment_description|linebreaks|default:"<span class='text-muted'>—</span>"|safe }}
        </div>
      </div>

    </div>
  </div>

  <!-- Recipients -->
  <div class="card mb-4 shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Recipients ({{ recipients|length }})</span>
    </div>
    <div class="card-body p-0" style="max-height: 260px; overflow-y: auto;">
      <table class="table table-sm mb-0 align-middle">
        <thead>
          <tr>
            <th>Email</th>
            <th>Client</th>
            <th>Status</th>
            <th>Sent At</th>
          </tr>
        </thead>
        <tbody>
        {% for r in recipients %}
          <tr>
            <td>{{ r.email }}</td>
            <td>{{ r.client|default:"—" }}</td>
            <td>{{ r.get_status_display }}</td>
            <td>{{ r.sent_at|date:"Y-m-d H:i"|default:"—" }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="4" class="text-muted text-center py-3">
              No recipients yet.
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

</div>
{% endblock %}
