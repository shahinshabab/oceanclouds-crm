{# templates/common/notification_list.html #}
{% extends "ui/base.html" %}

{% block title %}Notifications{% endblock %}

{% block content %}
<div class="container py-3">

  <!-- Header Row -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h1 class="h3 mb-0">Notifications</h1>
    </div>
  </div>

  <!-- Search + Filters Row -->
  <form method="get" class="row g-2 mb-3">
    <!-- Search -->
    <div class="col-md-4">
      <input type="text"
             name="q"
             value="{{ q }}"
             class="form-control"
             placeholder="Search by message or actor">
    </div>

    <!-- Category filter -->
    <div class="col-md-3">
      <select name="category" class="form-select">
        {% for value, label in category_choices %}
          <option value="{{ value }}" {% if category == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Status filter -->
    <div class="col-md-3">
      <select name="status" class="form-select">
        {% for value, label in status_choices %}
          <option value="{{ value }}" {% if status == value %}selected{% endif %}>
            {{ label }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Apply button -->
    <div class="col-md-2 d-grid">
      <button type="submit" class="btn btn-outline-secondary">
        Apply
      </button>
    </div>
  </form>

  {% if notifications %}
    <div class="d-flex flex-column gap-3">
      {% for note in notifications %}
        <div class="card border-0 shadow-sm {% if not note.is_read %}border-start border-4 border-primary{% endif %}">
          <div class="card-body">

            <!-- Top row: heading + date -->
            <div class="d-flex justify-content-between align-items-start mb-1">
              <div>
                <div class="text-uppercase text-muted small">
                  {{ note.get_notif_type_display }}
                </div>
              </div>
              <div class="small text-muted ms-3">
                {{ note.created_at|date:"M j, Y · H:i" }}
              </div>
            </div>

            <!-- Subheading row -->
            <div class="mb-2">
              <div class="small">
                {% if note.actor %}
                  {{ note.actor.get_full_name|default:note.actor.username }}
                {% else %}
                  <span class="text-muted">System notification</span>
                {% endif %}
              </div>
              {% if note.target %}
                <div class="small">
                  <a href="{{ note.get_target_url }}" class="text-decoration-none">
                    View related item
                  </a>
                </div>
              {% endif %}
            </div>

            <!-- Message row -->
            <div class="mb-3">
              {% if note.message %}
                <p class="mb-0">
                  {{ note.message }}
                </p>
              {% else %}
                <p class="mb-0 text-muted small">
                  (No message text provided)
                </p>
              {% endif %}
            </div>

            <!-- Bottom row: status (left) + buttons (right) -->
            <div class="d-flex justify-content-between align-items-center">
              <div>
                {% if not note.is_read %}
                    <form method="post"
                            action="{% url 'common:notification_mark_read' note.id %}"
                            class="d-inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit"
                                class="btn btn-sm btn-outline-secondary">
                        Mark as read
                        </button>
                    </form>
                    {% else %}
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary disabled"
                            disabled>
                        Read
                    </button>
                {% endif %}
              </div>

              <div class="d-flex gap-2">
                {% if note.target %}
                  <a href="{{ note.get_target_url }}"
                     class="btn btn-sm btn-outline-primary">
                    Open
                  </a>
                {% endif %}

                {% if not note.is_read %}
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary js-mark-notification-read"
                          data-id="{{ note.id }}"
                          data-url="{% url 'common:notification_mark_read' note.id %}">
                    Mark as read
                  </button>
                {% else %}
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary disabled"
                          disabled>
                    Read
                  </button>
                {% endif %}
              </div>
            </div>

          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div class="small text-muted">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </div>
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.previous_page_number }}&q={{ q }}&category={{ category }}&status={{ status }}">
                  Previous
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Previous</span>
              </li>
            {% endif %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                   href="?page={{ page_obj.next_page_number }}&q={{ q }}&category={{ category }}&status={{ status }}">
                  Next
                </a>
              </li>
            {% else %}
              <li class="page-item disabled">
                <span class="page-link">Next</span>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    {% endif %}
  {% else %}
    <div class="text-center text-muted py-5">
      No notifications found for the selected filters.
    </div>
  {% endif %}
</div>
<script>
(function () {
  // Helper: Read CSRF token from cookie
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  document.addEventListener("click", function (e) {
    const button = e.target.closest(".js-mark-notification-read");
    if (!button) return;

    e.preventDefault();

    const url = button.dataset.url;
    if (!url) {
      console.error("No data-url found on .js-mark-notification-read button");
      return;
    }

    fetch(url, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "X-Requested-With": "XMLHttpRequest",
        "Accept": "application/json",
      },
      credentials: "same-origin",  // ensure cookies are sent
    })
      .then((response) => {
        if (!response.ok) {
          console.error("HTTP error", response.status);
          // Fallback: reload anyway so you at least see updated status
          window.location.reload();
          return null;
        }
        return response.json();
      })
      .then((data) => {
        if (!data) return;
        if (data.success) {
          // ✅ Backend says it worked – refresh the page
          window.location.reload();
        } else {
          console.error("Mark read failed:", data);
        }
      })
      .catch((err) => {
        console.error("Error in mark-notification-read fetch:", err);
      });
  });
})();
</script>

{% endblock %}
